# D2 Dash v3 - AI 에이전트 개발 가이드라인

## 프로젝트 개요

**프로젝트명:** D2 Dash v3 - 투자 모니터링 대시보드  
**기술스택:** Flask, Python, HTML/CSS/JavaScript, JSON 데이터 저장  
**핵심기능:** DART 공시 모니터링, 주식 가격 추적, 이메일 알림 시스템  
**배포환경:** 로컬 웹서버 (http://localhost)  

## 프로젝트 아키텍처

### 디렉토리 구조
- `/` - 프로젝트 루트 (C:\2dept\v3)
- `app.py` - Flask 메인 애플리케이션
- `modules/` - 백엔드 모듈 (dart_monitor.py, stock_monitor.py, email_utils.py, config.py)
- `static/` - 프론트엔드 파일 (HTML, CSS, JS)
- `data/` - JSON 데이터 저장소
- `logs/` - 로그 파일 저장
- `.env` - 환경변수 설정

### 모듈 분할
- **dart_monitor.py**: DART OpenAPI 연동, 공시 데이터 수집
- **stock_monitor.py**: 주식 가격 추적, PyKrx/네이버 크롤링
- **email_utils.py**: 이메일 알림 발송
- **logger_utils.py**: 통합 로깅 시스템
- **config.py**: 설정값 관리

## 핵심 개발 규칙

### 파일 상호작용 규칙

**⚠️ 필수 준수사항:**
- `modules/` 폴더의 파이썬 모듈 수정시 `app.py`의 import와 라우트 함께 확인/수정할 것
- `static/` 폴더의 HTML 수정시 관련 JS 파일도 함께 수정할 것
- 새로운 API 엔드포인트 추가시 프론트엔드 JS에서 호출 코드도 추가할 것
- `config.py` 수정시 관련 모듈들의 변수명 일치 확인할 것
- 데이터 스키마 변경시 모든 관련 모듈의 데이터 처리 로직 동기화할 것

### 데이터 관리 표준

**JSON 파일 기반 저장:**
- 모든 영구 데이터는 `data/` 폴더의 JSON 파일로 저장할 것
- 주식 데이터: `data/monitoring_stocks.json`
- DART 데이터: `data/dart_companies.json`, `data/processed_ids.json`
- 사용자 데이터: `data/users.json`
- 설정 데이터: `data/settings.json`

**파일 동시 접근 방지:**
- JSON 파일 수정시 반드시 `FileLock` 사용할 것
- 백업 파일 생성 후 원본 파일 수정할 것
- 데이터 무결성 검증 로직 포함할 것

### 기능 구현 표준

**이메일 알림 시스템:**
- 모든 이메일 발송은 `email_utils.py`의 함수 사용할 것
- 주식 알림과 DART 알림은 별도 템플릿 사용할 것
- 발송 실패시 재시도 로직 포함할 것
- 이메일 설정은 `.env` 파일에서 관리할 것

**로깅 시스템:**
- 모든 로깅은 `logger_utils.py`의 `get_logger()` 사용할 것
- 모듈별 로거 인스턴스 분리 관리할 것
- 에러 로그는 스택트레이스 포함할 것
- 로그 파일은 `logs/` 폴더에 저장할 것

**실시간 모니터링:**
- 백그라운드 작업은 `threading` 모듈 사용할 것
- 주식 가격 체크는 10초 간격으로 실행할 것
- 시장 시간(09:00-15:30) 외에는 모니터링 중단할 것
- WebSocket 연결로 실시간 업데이트 제공할 것

### UI/UX 개발 표준

**반응형 디자인:**
- 모든 페이지는 모바일 환경 지원할 것
- CSS Grid/Flexbox 사용하여 레이아웃 구성할 것
- 최소 해상도 320px 지원할 것

**사용자 인터랙션:**
- 모든 사용자 액션에 로딩 상태 표시할 것
- 에러 발생시 명확한 에러 메시지 표시할 것
- 성공적인 액션에 대한 피드백 제공할 것
- 폼 입력시 실시간 유효성 검증 제공할 것

## 코딩 표준

### 명명 규칙
- **Python**: snake_case (함수, 변수, 모듈)
- **Python**: PascalCase (클래스명)
- **JavaScript**: camelCase (함수, 변수)
- **CSS**: kebab-case (클래스명)
- **파일명**: snake_case (Python), kebab-case (HTML/CSS/JS)

### 주석 규칙
- 모든 함수에 docstring 작성할 것
- 복잡한 로직에는 인라인 주석 추가할 것
- TODO/FIXME 주석 사용하여 개선점 표시할 것
- API 엔드포인트에는 입력/출력 스키마 문서화할 것

### 에러 처리
- 모든 외부 API 호출에 try-catch 블록 적용할 것
- 사용자 입력 검증 로직 포함할 것
- 에러 메시지는 사용자 친화적으로 작성할 것
- 치명적 에러는 관리자에게 이메일 알림 발송할 것

## 특정 기능 구현 가이드

### 주식 모니터링 구현
- **카테고리 분류**: 메자닌/주식 2개 카테고리로 구분할 것
- **종목 관리**: 추가/삭제/편집 기능 제공할 것
- **가격 모니터링**: PyKrx 우선, 실패시 네이버 크롤링 사용할 것
- **알림 조건**: 상한/하한 임계값 설정 기능 제공할 것
- **장종료 보고서**: 15:30 이후 하루 결과 이메일 발송할 것

### DART 공시 모니터링 구현
- **종목 관리**: 관심 종목 추가/삭제 기능 제공할 것
- **보고서 키워드**: 특정 보고서명 필터링 기능 제공할 것
- **AND 조건**: 종목 + 키워드 모두 일치시 알림 발송할 것
- **중복 방지**: 처리된 공시 ID 저장하여 중복 알림 방지할 것

### 로그인 시스템 구현
- **사용자 관리**: JSON 파일 기반 사용자 데이터 저장할 것
- **세션 관리**: Flask-Session 사용하여 로그인 상태 관리할 것
- **권한 관리**: 일반 사용자/관리자 권한 구분할 것
- **승인 시스템**: 신규 가입시 관리자 승인 필요하게 할 것

## 의존성 관리

### 필수 라이브러리
- **Flask**: 웹 프레임워크
- **requests**: HTTP 클라이언트
- **beautifulsoup4**: 웹 스크래핑
- **pykrx**: 주식 데이터 (선택적)
- **filelock**: 파일 동시 접근 방지
- **python-dotenv**: 환경변수 관리

### 외부 API
- **DART OpenAPI**: 공시 데이터 수집
- **네이버 금융**: 주식 가격 크롤링 (백업용)
- **SendGrid/SMTP**: 이메일 발송

## 워크플로우 표준

### 개발 프로세스
1. 기능 요구사항 분석
2. 관련 모듈/파일 식별
3. 백엔드 API 구현
4. 프론트엔드 UI 구현
5. 통합 테스트 수행
6. 에러 처리 검증
7. 문서화 업데이트

### 테스트 절차
- 단위 테스트: 각 모듈별 기능 검증
- 통합 테스트: API 엔드포인트 동작 확인
- UI 테스트: 브라우저에서 사용자 시나리오 테스트
- 부하 테스트: 동시 사용자 환경 시뮬레이션

## AI 의사결정 기준

### 우선순위 판단
1. **보안** > 기능 > 성능
2. **데이터 안정성** > 사용자 편의성
3. **기존 시스템 호환성** > 새로운 기능

### 모호한 상황 처리
- 기존 코드 패턴 분석하여 일관성 유지할 것
- 불확실한 요구사항은 보수적으로 접근할 것
- 중요한 변경사항은 백업 생성 후 진행할 것

## 금지 사항

### ❌ 절대 금지
- 기존 JSON 데이터 파일의 스키마를 임의 변경하지 말 것
- 보안에 민감한 정보를 평문으로 저장하지 말 것
- 동기화되지 않은 멀티스레딩 코드를 작성하지 말 것
- 사용자 입력을 검증 없이 처리하지 말 것
- 외부 의존성 없이 작동해야 하는 핵심 기능을 외부 라이브러리에 의존시키지 말 것

### ⚠️ 주의 사항
- PyKrx 라이브러리는 선택적 의존성으로 처리할 것
- 이메일 발송 실패가 전체 시스템을 중단시키지 않도록 할 것
- 대량의 로그 파일이 디스크 공간을 고갈시키지 않도록 로테이션 설정할 것

## 예시

### ✅ 올바른 구현
```python
# 데이터 파일 수정시
with FileLock(f"{data_file}.lock"):
    with open(data_file, 'r') as f:
        data = json.load(f)
    # 데이터 수정
    with open(data_file, 'w') as f:
        json.dump(data, f, indent=2)
```

### ❌ 잘못된 구현
```python
# 동시 접근 제어 없이 파일 수정
with open(data_file, 'w') as f:
    json.dump(data, f)
```

---

**최종 업데이트:** 2025-07-27  
**문서 버전:** v3.0  

## 프로젝트 개요

투자본부 모니터링 시스템 v3 - Flask 백엔드와 JavaScript SPA 프론트엔드로 구성된 DART 공시 모니터링 및 주식 가격 추적 웹 애플리케이션

- **프로젝트 루트**: C:\2dept\v3
- **서빙 URL**: http://localhost
- **기술 스택**: Flask + JavaScript SPA + MySQL
- **주요 기능**: DART 공시 모니터링, 주식 투자 모니터링, 통합 알림 시스템

## 프로젝트 아키텍처

### 디렉토리 구조 규칙

- **백엔드**: app.py (메인 Flask 서버)
- **모듈**: modules/ (config.py, dart_monitor.py, stock_monitor.py, email_utils.py)
- **프론트엔드**: static/ (index.html, dart.html, script.js, dart.js, style.css)
- **로그**: logs/ (app.log, error.log 등)
- **데이터**: data/ (JSON 파일, 임시 데이터)

### 모듈화 원칙

- **절대 금지**: app.py에 모든 로직을 작성하는 것
- **필수 준수**: 기능별로 modules/ 폴더의 해당 파일에 구현
- **의존성 관리**: modules/__init__.py 파일 유지

## SPA 라우팅 규칙

### Flask Catch-All 라우트 구현

**필수 구현**: app.py에 다음 패턴으로 catch-all 라우트 추가

```python
@app.route('/', defaults={'path': ''})
@app.route('/<path:path>')
def serve_spa(path):
    # API 요청은 제외
    if path.startswith('api/'):
        return jsonify({'error': 'API endpoint not found'}), 404
    
    # 정적 파일 요청 처리
    if path and os.path.exists(os.path.join(app.static_folder, path)):
        return send_from_directory(app.static_folder, path)
    
    # SPA 라우트는 index.html 반환
    return send_from_directory(app.static_folder, 'index.html')
```

### 라우트 우선순위

1. **API 라우트**: /api/v1/* (최우선)
2. **정적 파일**: /static/* (두 번째)
3. **SPA 라우트**: 나머지 모든 경로 (마지막)

## API 표준

### URL 패턴

- **필수 사용**: 모든 API는 `/api/v1/` prefix 사용
- **금지**: `/api/` 단독 사용 (버전 관리 불가)

### API 응답 형식 표준

**성공 응답**:
```json
{
    "status": "success",
    "data": {...},
    "message": "Optional success message"
}
```

**에러 응답**:
```json
{
    "status": "error",
    "error": "Error description",
    "code": "ERROR_CODE"
}
```

### DART API 특수 규칙

- **날짜 형식**: 반드시 YYYYMMDD 사용 (예: "20241201")
- **기본 날짜 범위**: 미지정 시 최근 12개월
- **최대 조회 기간**: 한 번에 1년 이내로 제한

## 파일 수정 연계 규칙

### Flask 백엔드 수정 시

**app.py 수정 시 필수 확인**:
- modules/config.py (설정 변경 영향)
- modules/dart_monitor.py (DART 관련 수정 시)
- modules/stock_monitor.py (주식 관련 수정 시)
- requirements.txt (새 패키지 추가 시)

### JavaScript 프론트엔드 수정 시

## 주식 모니터링 UI 표준

### 탭 구조 구현 규칙

**필수 구현**: 주식 모니터링 페이지는 다음 3개 탭으로 구성할 것
- **전체**: 모든 모니터링 종목 표시 (종목 수 실시간 업데이트)
- **매수만**: category가 '매수'인 종목만 필터링
- **기타**: category가 '기타'인 종목만 필터링

**탭 표시 형식**: "탭명 (종목수)" 형태로 표시 (예: "전체 (29)", "매수만 (15)")

### 종목 테이블 컬럼 표준

**필수 컬럼 순서**:
1. **종목코드** (6자리) - 클릭 시 종목 수정 모달
2. **종목명** - 한글명 표시
3. **현재가** - 실시간 업데이트, 천 단위 콤마
4. **등락률** - 색상 구분 (상승: 빨강, 하락: 파랑)
5. **목표가(TP)** - Target Price
6. **손절가(SL)** - Stop Loss  
7. **마지막 체크** - 마지막 가격 업데이트 시간
8. **상태** - 모니터링 중/off
9. **알람설정** - on/off

**색상 규칙**:
- 상승: #f44336 (빨강)
- 하락: #2196f3 (파랑)
- 보합: #757575 (회색)

### 실시간 업데이트 규칙

**업데이트 주기**: 10초마다 전체 종목 가격 갱신
**장시간 제한**: 09:00-15:30 시간대만 활성화
**UI 반영**: 가격 변경 시 1초간 하이라이트 효과

## 모달 팝업 구현 표준

### 종목 추가/수정 모달 필수 요소

**라디오 버튼**: 매수/기타 선택 (필수)
**입력 필드**:
- 종목코드 (6자리, 숫자만)
- 목표가(TP) (숫자, 천 단위 콤마)
- 손절가(SL) (숫자, 천 단위 콤마)  
- 전일가 (참고용, 자동 입력)
- 전일가(floor) (하한선)
- 취득가 (매수 카테고리만)

**알림 설정**:
- 일일 급등 알림 활성화 (체크박스)
- 급등 임계값 (기본값: 5%)
- 급락 임계값 (기본값: 5%)
- 메모 (선택사항)
- 패리티 알림 퍼센트 설정

**버튼**: 저장/취소

### 유효성 검사 규칙

- **종목코드**: 6자리 숫자, 실제 존재하는 종목인지 API로 검증
- **목표가**: 현재가보다 높아야 함 (매수 카테고리)
- **손절가**: 현재가보다 낮아야 함 (매수 카테고리)
- **임계값**: 1-50% 범위 내 숫자

## 데이터 분류 시스템

### 카테고리 관리 규칙

**매수 카테고리**:
- 실제 보유 종목
- 목표가/손절가 필수 설정
- 취득가 입력 필수
- 수익률 계산 표시

**기타 카테고리**:
- 관심 종목, 분석 대상
- 목표가/손절가 선택사항
- 취득가 불필요
- 등락률만 표시

### 데이터 저장 형식

```json
{
  "code": "005930",
  "name": "삼성전자",
  "category": "매수|기타",
  "target_price": 85000,
  "stop_loss": 75000,
  "acquisition_price": 80000,
  "alert_settings": {
    "daily_alert": true,
    "rise_threshold": 5,
    "fall_threshold": 5,
    "parity_percent": 80
  },
  "memo": "선택사항",
  "created_at": "2025-07-27T10:30:00Z",
  "updated_at": "2025-07-27T10:30:00Z"
}
```

## 알림 시스템 세부 규칙

### 패리티 알림

**발동 조건**: 설정한 퍼센트에 도달 시
**계산 공식**: (현재가 / 목표가) * 100
**예시**: 목표가 100,000원, 패리티 80% 설정 → 80,000원 도달시 알림

### 급등급락 알림

**일일 기준**: 전일 종가 대비 설정 임계값 초과시
**실시간 기준**: 최근 1시간 내 설정 임계값 초과시
**중복 방지**: 동일 조건으로 1일 1회만 알림

### 목표가/손절가 알림

**목표가 도달**: 현재가 >= 목표가
**손절가 도달**: 현재가 <= 손절가
**즉시 알림**: 조건 달성 즉시 이메일 발송

## 실시간 로그 시스템

### 일일 내역 표시 규칙

**컬럼 구성**:
- 시간 (HH:MM:SS)
- 종목코드
- 동작 (급등/급락/목표가/손절가)
- 알림 유형 (독과 투웹↑/독과 투웹↓)
- 현재가
- 기준가

**정렬**: 시간 역순 (최신이 위)
**보관 기간**: 당일만 표시, 자정에 초기화

### 실시간 로그 표시 규칙

**로그 내용**:
- 수동 새로고침 실행 시간
- 데이터 모드 업뎃 완료 로그
- UI 데이터 로드 완료 로그
- 종목 수: 총 119개 등 정보

**표시 형식**: "YYYY-MM-DD HH:MM:SS,mmm - INFO - 메시지"
**자동 스크롤**: 새 로그 추가시 하단으로 자동 이동
**새로고침 주기**: 60초마다 로그 갱신

## 특수 UI 컴포넌트 규칙

### 새로고침 주기 설정

**위치**: 우측 하단
**옵션**: 60초 선택 드롭다운
**동작**: 설정 변경시 즉시 적용

### 모니터링 상태 표시

**아이콘**: 녹색 원 (정상), 빨간 원 (오류)
**위치**: 각 종목 행의 상태 컬럼
**클릭 동작**: 모니터링 on/off 토글

### 반응형 레이아웃

**데스크톱**: 전체 테이블 표시
**태블릿**: 일부 컬럼 숨김 (메모, 마지막체크)
**모바일**: 카드 형태로 변경, 필수 정보만 표시

**최종 업데이트:** 2025-07-27  
**문서 버전:** v3.1 (주식 모니터링 시스템 특화)
**script.js 수정 시 필수 확인**:
- index.html (DOM 요소 변경 확인)
- style.css (새 스타일 클래스 추가 시)
- dart.js (공통 함수 수정 시)

**dart.js 수정 시 필수 확인**:
- dart.html (DART 페이지 관련 수정)
- script.js (공통 API 호출 함수 수정 시)

### 데이터베이스 연관 파일

**MySQL 스키마 변경 시 필수 확인**:
- modules/config.py (DB 설정)
- modules/stock_monitor.py (주식 데이터 테이블 관련)
- modules/dart_monitor.py (DART 데이터 테이블 관련)

## 로깅 및 디버깅 규칙

### 로그 파일 규칙

- **app.log**: 모든 일반 로그
- **error.log**: 에러 전용 로그
- **debug.log**: 개발 시 디버그 로그

### 로깅 레벨 사용

- **ERROR**: 시스템 중단 수준 오류
- **WARNING**: 기능 영향을 주는 문제
- **INFO**: 정상 동작 기록
- **DEBUG**: 개발/테스트 정보

### 필수 로깅 위치

- **API 요청/응답**: 모든 API 호출 시작과 종료
- **DART API 호출**: 외부 API 호출 시작, 종료, 에러
- **데이터베이스 작업**: CRUD 작업 전후
- **에러 발생**: 모든 try-catch 블록에서 exception 로깅

## Git 워크플로우 규칙

### 커밋 메시지 형식

```
<type>: <description>

<body>
```

**타입 종류**:
- feat: 새 기능 추가
- fix: 버그 수정
- refactor: 코드 리팩토링
- docs: 문서 변경
- test: 테스트 코드
- style: 코드 스타일 변경

### 브랜치 관리

- **main**: 운영 브랜치
- **test**: 테스트 브랜치
- **feature/***: 기능 개발 브랜치

### 필수 Git 작업 순서

1. 파일 수정 후 즉시: `git add .`
2. 의미있는 단위로: `git commit -m "type: description"`
3. 테스트 완료 후: `git push origin test`
4. 검증 완료 후: PR로 main 병합

## 에러 처리 표준

### 프론트엔드 에러 처리

**필수 구현**: 모든 fetch 호출에 try-catch
```javascript
try {
    const response = await fetch('/api/v1/endpoint');
    if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    const data = await response.json();
    // 정상 처리
} catch (error) {
    console.error('API 호출 실패:', error);
    // 사용자에게 에러 표시
}
```

### 백엔드 에러 처리

**필수 구현**: 모든 API 엔드포인트에 try-except
```python
@app.route('/api/v1/endpoint')
def api_endpoint():
    try:
        # 로직 구현
        return jsonify({'status': 'success', 'data': result})
    except Exception as e:
        logger.error(f"API 에러: {str(e)}")
        return jsonify({'status': 'error', 'error': str(e)}), 500
```

## 데이터 형식 규칙

### 날짜/시간 형식

- **DART API**: YYYYMMDD (예: "20241201")
- **내부 저장**: ISO 8601 (예: "2024-12-01T10:30:00Z")
- **화면 표시**: YYYY-MM-DD HH:MM (예: "2024-12-01 10:30")

### 통화 표시

- **원화**: 천 단위 콤마, "원" 단위 (예: "1,234,567원")
- **달러**: 소수점 2자리, "$" 기호 (예: "$1,234.56")

## 성능 최적화 규칙

### API 응답 최적화

- **페이징**: 목록 조회 시 limit/offset 파라미터 필수
- **필드 선택**: 필요한 필드만 반환
- **캐싱**: 동일 요청은 5분간 캐시

### 프론트엔드 최적화

- **지연 로딩**: 초기 로드 시 필수 데이터만
- **배치 요청**: 여러 API 호출을 하나로 통합
- **에러 재시도**: 네트워크 에러 시 3회까지 자동 재시도

## 보안 규칙

### API 보안

- **입력 검증**: 모든 파라미터 검증 필수
- **SQL 인젝션 방지**: ORM 사용 또는 파라미터 바인딩
- **로그 민감정보**: 비밀번호, API 키 로깅 금지

### 설정 파일 관리

- **.env**: 민감한 설정 정보 (Git 추적 제외)
- **.env.example**: 설정 템플릿 (Git 포함)
- **config.py**: 환경변수 로드 및 기본값 설정

## 금지 사항

### 절대 금지 사항

- **하드코딩**: API 키, 비밀번호, DB 연결 정보
- **전역 변수**: 스레드 안전하지 않은 전역 상태
- **블로킹 호출**: 메인 스레드에서 긴 작업 수행
- **에러 무시**: try-except에서 pass 사용

### 코드 품질 금지

- **거대 함수**: 50줄 이상 함수 작성
- **깊은 중첩**: 4단계 이상 if/for 중첩
- **매직 넘버**: 의미 없는 숫자 하드코딩
- **중복 코드**: 동일 로직 3회 이상 반복

### 파일 수정 금지

- **프로덕션 로그**: 운영 중 로그 파일 직접 수정
- **Git 히스토리**: 이미 푸시된 커밋 수정
- **node_modules**: npm 패키지 직접 수정
- **__pycache__**: Python 캐시 파일 수동 수정

## 테스트 규칙

### 단위 테스트

- **모든 API**: 정상/에러 케이스 테스트
- **모든 함수**: 입력/출력 검증
- **커버리지**: 최소 80% 이상

### 통합 테스트

- **API 플로우**: 전체 사용자 시나리오
- **데이터베이스**: 실제 DB 연동 테스트
- **외부 API**: DART API 연동 테스트

### 성능 테스트

- **응답 시간**: API 3초 이내 응답
- **동시 접속**: 10명 동시 사용 가능
- **메모리 사용량**: 500MB 이내 유지